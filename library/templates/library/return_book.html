{% extends "library/base.html" %}

{% block title %}Return Book{% endblock %}

{% block content %}

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<div class="return-container">
    <h2><i class="fas fa-undo-alt"></i> Return Book</h2>

    <!-- Flash messages -->
    {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <i class="fas fa-info-circle"></i> {{ message }}
                    <button class="close" onclick="this.parentElement.style.display='none';">&times;</button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Search Form -->
    <form method="GET" action="{% url 'return_book' %}" class="search-form">
        <input type="text" name="search" value="{{ search_query }}" placeholder="üîç Search Book, ISBN, or User ID..." />
        <button type="submit"><i class="fas fa-search"></i> Search</button>
    </form>

    <!-- Return Book Form -->
    <form method="POST" action="{% url 'return_book' %}" class="return-form">
        {% csrf_token %}
          
        <!-- OTP field   --------------------------- -->

        <div class="form-group">
            <label><i class="fas fa-key"></i> Enter OTP</label>
            <div class="otp-row">
                <input type="text" name="otp_input" id="otp_input" placeholder="Enter 6-digit OTP" required>
                <button type="button" class="btn-send-otp" onclick="sendOTP()" title="Send OTP to Admin">
                    <i class="fas fa-paper-plane"></i> Send OTP
                </button>
            </div>
        </div>


        <!-- Password Input -->
        <div class="form-group">
            <label><i class="fas fa-lock"></i> Admin Password</label>
            <input type="password" name="password" id="password" placeholder="Enter admin password" required>
        </div>

        <!-- Book Select Dropdown -->
        <div class="form-group">
            <label><i class="fas fa-book"></i> Select Issued Book</label>
            <select name="issued_book" required>
                {% for issued_book in issued_books %}
                <option value="{{ issued_book.id }}">
                    {{ issued_book.book.title }} (ISBN: {{ issued_book.book.isbn }})
                    - {% if issued_book.issued_to_student %}
                        {{ issued_book.issued_to_student.student_id }} - {{ issued_book.issued_to_student.first_name }} {{ issued_book.issued_to_student.last_name }}
                      {% elif issued_book.issued_to_faculty %}
                        {{ issued_book.issued_to_faculty.faculty_id }} - {{ issued_book.issued_to_faculty.first_name }} {{ issued_book.issued_to_faculty.last_name }}
                      {% endif %}
                      (Issued: {{ issued_book.issue_date }})
                </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn-return"><i class="fas fa-undo"></i> Return Book</button>
    </form>
</div>

<!-- Custom CSS + JS (unchanged) -->
<style>
.return-container {
    max-width: 800px;
    margin: 40px auto;
    background: #f9fbff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.return-container h2 {
    text-align: center;
    color: #004085;
    margin-bottom: 30px;
    font-size: 28px;
}

.alert-container {
    margin-bottom: 20px;
}

.alert {
    background: #e9f7ef;
    border-left: 5px solid #28a745;
    padding: 15px 20px;
    margin-bottom: 10px;
    border-radius: 8px;
    color: #155724;
    position: relative;
    font-size: 15px;
}

.alert .close {
    position: absolute;
    right: 15px;
    top: 12px;
    background: none;
    border: none;
    font-size: 18px;
    color: #155724;
    cursor: pointer;
}

.search-form {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
}

.search-form input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.search-form button {
    background: #007bff;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
}

.search-form button:hover {
    background: #0056b3;
}

.return-form {
    background: #ffffff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    animation: fadeIn 0.5s ease-in;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    transition: border-color 0.3s;
}

.form-group input:focus, .form-group select:focus {
    border-color: #007bff;
    outline: none;
}

.btn-return {
    width: 100%;
    background-color: #28a745;
    color: white;
    padding: 14px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s;
}

.btn-return:hover {
    background-color: #218838;
    transform: scale(1.02);
}

@keyframes fadeIn {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 1; transform: translateY(0);}
}

@media (max-width: 768px) {
    .return-container {
        padding: 20px;
    }

    .search-form {
        flex-direction: column;
    }

    .search-form input, .search-form button {
        width: 100%;
    }
}
.otp-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.otp-row input {
    flex: 1;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.btn-send-otp {
    padding: 10px 14px;
    background-color: #17a2b8;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s;
    white-space: nowrap;
    height: 42px;
}

.btn-send-otp:hover {
    background-color: #138496;
    transform: scale(1.05);
}
</style>

<script>
    function sendOTP() {
        fetch("/send-otp/", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("‚úÖ OTP sent to admin email.");
            } else {
                alert("‚ùå Failed to send OTP.");
            }
        })
        .catch(err => {
            alert("‚ùå Error sending OTP.");
            console.error(err);
        });
    }
</script>

{% endblock %}
