{% extends "library/base.html" %}
{% block title %}Scan & Issue Book{% endblock %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<div class="scanner-container">
    <h2 class="title"><i class="fas fa-qrcode"></i> Scan & Issue Book</h2>

    <form method="POST" action="{% url 'issue_book_form' %}" class="issue-form">
        {% csrf_token %}

        <!-- Password -->
        <div class="form-card">
            <h3><i class="fas fa-lock"></i> Password</h3>
            <input type="password" name="password" class="styled-input" placeholder="Enter password" required>
        </div>

        <!-- Role -->
        <div class="form-card">
            <h3><i class="fas fa-user-tag"></i> Select Role</h3>
            <select name="issued_to_role" id="issued_to_role" class="styled-input" required>
                <option value="">-- Select Role --</option>
                <option value="student">Student</option>
                <option value="faculty">Faculty</option>
            </select>
        </div>

        <!-- Scanner Area -->
        <div class="scanner-row">
            <!-- Person QR -->
            <div class="scanner-box">
                <h4><i class="fas fa-user"></i> Scan Person QR</h4>
                <div id="reader-person" class="qr-reader"></div>
                <button type="button" class="btn-success webcam-btn" onclick="startPersonScanner()">Start Webcam</button>
                <input type="file" accept="image/*" capture="environment"
                       id="upload-person" class="file-input"
                       onchange="previewImage(this, 'reader-person'); decodeQRCodeFromFile(this, document.getElementById('person-result'), false);">
                <input type="hidden" name="issued_to" id="person_id">
                <p class="scan-feedback">Detected: <span id="person-result">Waiting...</span></p>
            </div>

            <!-- Book QR -->
            <div class="scanner-box">
                <h4><i class="fas fa-book"></i> Scan Book QR</h4>
                <div id="reader-book" class="qr-reader"></div>
                <button type="button" class="btn-success webcam-btn" onclick="startBookScanner()">Start Webcam</button>
                <input type="file" accept="image/*" capture="environment"
                       id="upload-book" class="file-input"
                       onchange="previewImage(this, 'reader-book'); decodeQRCodeFromFile(this, document.getElementById('book-result'), true);">
                <input type="hidden" name="book" id="book_id">
                <p class="scan-feedback">Detected: <span id="book-result">Waiting...</span></p>
            </div>
        </div>

        <!-- Dates -->
        <div class="form-card">
            <h3><i class="fas fa-calendar-day"></i> Issue Date</h3>
            <input type="date" name="issue_date" id="issue_date" class="styled-input" required value="">

        </div>

        <div class="form-card">
            <h3><i class="fas fa-calendar-check"></i> Return Date</h3>
            <input type="date" name="return_date" id="return_date" class="styled-input" readonly>
        </div>

        <!-- Buttons -->
        <div class="btn-group">
            <button type="submit" class="btn-success"><i class="fas fa-check-circle"></i> Issue Book</button>
            <button type="button" class="btn-warning" onclick="resetAll()"><i class="fas fa-undo"></i> Reset</button>
        </div>
    </form>
</div>

<script>
    let personID = null, bookID = null;
    let scannerPerson = new Html5Qrcode("reader-person");
    let scannerBook = new Html5Qrcode("reader-book");

    function extractISBN(data) {
        const match = data.match(/ISBN:\s*(\d+)/i);
        return match ? match[1] : null;
    }

    function extractPersonCode(data) {
        const match = data.match(/(Student|Faculty) Id:\s*(\d+)/i);
        return match ? match[2] : null;
    }

    function fetchBookIdFromISBN(isbn) {
        fetch(`/api/get-book-id/?isbn=${isbn}`)
            .then(res => res.json())
            .then(data => {
                if (data.book_id) {
                    bookID = data.book_id;
                    document.getElementById("book_id").value = bookID;
                    document.getElementById("book-result").innerText = "✅ ISBN: " + isbn;
                } else {
                    alert("❌ Book not found.");
                }
            });
    }

    function fetchPersonDbId(personCode) {
        const role = document.getElementById("issued_to_role").value;
        if (!role) {
            alert("Please select role first.");
            return;
        }
        fetch(`/api/get-person-id/?code=${personCode}`)
            .then(res => res.json())
            .then(data => {
                if (data.id && data.role === role) {
                    personID = data.id;
                    document.getElementById("person_id").value = personID;
                    document.getElementById("person-result").innerText = `✅ ID: ${personCode}`;
                } else {
                    alert("❌ Person not found or role mismatch.");
                }
            });
    }

    function decodeQRCodeFromFile(fileInput, resultElement, isBook = false) {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function () {
            const img = new Image();
            img.src = reader.result;
            img.onload = function () {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) {
                    const data = code.data.trim();
                    resultElement.innerText = data;
                    if (isBook) {
                        const isbn = extractISBN(data);
                        if (isbn) fetchBookIdFromISBN(isbn);
                        else alert("❌ ISBN not found in QR.");
                        scannerBook.stop().catch(() => {});
                    } else {
                        const personCode = extractPersonCode(data);
                        if (personCode) fetchPersonDbId(personCode);
                        else alert("❌ Person ID not found in QR.");
                        scannerPerson.stop().catch(() => {});
                    }
                } else {
                    alert("❌ QR not detected.");
                }
            };
        };
        reader.readAsDataURL(file);
    }

    function previewImage(input, readerId) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            const previewBox = document.getElementById(readerId);
            previewBox.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;">`;
        };
        reader.readAsDataURL(file);
    }

    function startPersonScanner() {
        Html5Qrcode.getCameras().then(devices => {
            if (devices.length) {
                scannerPerson.start(
                    devices[0].id,
                    { fps: 10, qrbox: 250 },
                    (text) => {
                        const code = extractPersonCode(text);
                        if (code) {
                            fetchPersonDbId(code);
                            scannerPerson.stop().catch(console.error);
                        }
                    },
                    err => console.warn("Person scan error:", err)
                );
            } else {
                alert("❌ No webcam found.");
            }
        }).catch(err => alert("Camera error: " + err));
    }

    function startBookScanner() {
        Html5Qrcode.getCameras().then(devices => {
            if (devices.length) {
                scannerBook.start(
                    devices[0].id,
                    { fps: 10, qrbox: 250 },
                    (text) => {
                        const code = extractISBN(text);
                        if (code) {
                            fetchBookIdFromISBN(code);
                            scannerBook.stop().catch(console.error);
                        }
                    },
                    err => console.warn("Book scan error:", err)
                );
            } else {
                alert("❌ No webcam found.");
            }
        }).catch(err => alert("Camera error: " + err));
    }

    function resetAll() {
        personID = null;
        bookID = null;
        document.getElementById("person_id").value = "";
        document.getElementById("book_id").value = "";
        document.getElementById("issued_to_role").value = "";
        document.getElementById("person-result").innerText = "Waiting...";
        document.getElementById("book-result").innerText = "Waiting...";
        scannerPerson.stop().then(() => {}).catch(() => {});
        scannerBook.stop().then(() => {}).catch(() => {});
    }

    document.addEventListener("DOMContentLoaded", function () {
        const issueDateInput = document.getElementById("issue_date");
        const returnDateInput = document.getElementById("return_date");

        // Set today's date as default for issue date
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        issueDateInput.value = todayStr;

        // Set return date +15 days
        const defaultReturnDate = new Date(today);
        defaultReturnDate.setDate(today.getDate() + 15);
        returnDateInput.value = defaultReturnDate.toISOString().split('T')[0];

        // When issue date is changed manually, recalculate return date
        issueDateInput.addEventListener("change", function () {
            const issueDate = new Date(this.value);
            if (!isNaN(issueDate)) {
                const returnDate = new Date(issueDate);
                returnDate.setDate(issueDate.getDate() + 15);
                returnDateInput.value = returnDate.toISOString().split('T')[0];
            }
        });
    });
</script>

<style>
    .scanner-container {
        max-width: 900px;
        margin: auto;
        padding: 30px;
        background: #f0f4ff;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .title {
        text-align: center;
        color: #003366;
        margin-bottom: 30px;
        font-size: 28px;
    }

    .form-card {
        margin-bottom: 20px;
    }

    .form-card h3 {
        margin-bottom: 8px;
        color: #004080;
    }

    .scanner-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .scanner-box {
        flex: 1 1 300px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
        text-align: center;
    }

    .scanner-box h4 {
        margin-bottom: 10px;
        color: #003366;
    }

    .qr-reader {
        width: 100%;
        height: 280px;
        border: 2px dashed #3399ff;
        border-radius: 10px;
        margin-bottom: 10px;
        animation: pulse 2s infinite;
    }

    .styled-input, .file-input, select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 5px;
        transition: border-color 0.3s;
    }

    .styled-input:focus, select:focus {
        outline: none;
        border-color: #3399ff;
    }

    .scan-feedback {
        margin-top: 8px;
        font-size: 14px;
        color: #333;
    }

    .btn-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }

    .btn-success, .btn-warning {
        padding: 12px 25px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
        transform: scale(1.05);
    }

    .btn-warning {
        background-color: #ffc107;
        color: black;
    }

    .btn-warning:hover {
        background-color: #e0a800;
        transform: scale(1.05);
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(51,153,255, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(51,153,255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(51,153,255, 0); }
    }

    /* Hide webcam buttons on small screens */
    @media (max-width: 768px) {
        .webcam-btn {
            display: none;
        }
    }
</style>

{% endblock %}
